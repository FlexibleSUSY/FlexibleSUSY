name: tests

on:

  push:
    branches:
      - development
      - test-PR-head
    paths-ignore:
      - '*.rst'
      - 'AUTHORS'
      - 'COPYING'
      - 'doc/**'

  pull_request:
    branches:
      - development
      - test-PR-head
    paths-ignore:
      - '*.rst'
      - 'AUTHORS'
      - 'COPYING'
      - 'doc/**'

jobs:

  build:

#   if: github.repository == 'FlexibleSUSY/FlexibleSUSY'
    runs-on: ubuntu-18.04

    strategy:
      matrix:
        CXXCOMPILER: [g++, clang++]
        LOOPLIBRARY: [internal]

    env:
      IMAGE_VERSION: '0.2.3'
      SARAH_VERSION: '4.14.3'
      FEYNARTS_VERSION: '3.11'
      FORMCALC_VERSION: '9.9'
      LOOPTOOLS_VERSION: '2.15'
      MODELS: 'SM THDMII MSSM MRSSM2 MSSMCPV MSSMNoFV ScalarLeptoquarks LRLR'

    steps:

      # action checks-out our repository directly under $GITHUB_WORKSPACE
      - name: Checkout
        uses: actions/checkout@v2

      - name: Pull the docker image
        run: docker pull navir/opensuseleap-for-flexiblesusy:$IMAGE_VERSION

      - name: Run the image
        # mount $GITHUB_WORKSPACE as /FlexibleSUSY on the container
        run: docker run -it -d --name builder -v $GITHUB_WORKSPACE:/FlexibleSUSY navir/opensuseleap-for-flexiblesusy:$IMAGE_VERSION

      - name: Copy Wolfram Engine license to the image
        run: |
          echo $ref
          docker exec builder bash -c "mkdir /root/.WolframEngine && mkdir /root/.WolframEngine/Licensing && echo $MATHPASS > /root/.WolframEngine/Licensing/mathpass"
          docker exec builder bash -c 'printf "Checking is Wolfram Engine workings... "; if [ $(wolframscript -code 1+2) -eq 3 ]; then echo OK; else echo fail && exit 1; fi'
        env:
          MATHPASS: ${{ secrets.MATHPASS }}
          ref: ${{ github.event.pull_request.head.ref }}

