name: tests

on:

  push:
    branches:
      - master
      - development
    paths-ignore:
      - '*.rst'
      - '.clang-tidy'
      - '.clang-format'
      - 'AUTHORS'
      - 'COPYING'
      - 'doc/**'
      - 'install-sarah'

  pull_request:
    branches:
      - master
      - development
    paths-ignore:
      - '*.rst'
      - '.clang-tidy'
      - '.clang-format'
      - 'AUTHORS'
      - 'COPYING'
      - 'doc/**'
      - 'install-sarah'

jobs:
  no-meta:
    strategy:
      matrix:
        OS: [macos-10.15, ubuntu-latest]
        CXXCOMPILER: [g++, clang++]
    runs-on: ${{ matrix.OS }}
    if: false

    steps:
      - name: Homebrew
        if: runner.os == 'macOS'
        run: |
          brew update
          brew upgrade
          brew reinstall gcc
          brew install gsl

      - name: Checkout
        uses: actions/checkout@v3

      - name: Install conan
        run: |
          pip3 install --user conan
          export PATH=$(python3 -c 'import site; print(site.USER_BASE + "/bin")'):$PATH
          conan profile new default --detect

      - name: Setup conan
        run: |
          export PATH=$(python3 -c 'import site; print(site.USER_BASE + "/bin")'):$PATH
          conan profile update settings.compiler.libcxx=libstdc++11 default
        env:
          CXX: ${{ matrix.CXXCOMPILER }}
        if: ${{ runner.os == 'Linux' }}

      - name: Install dependencies
        run: |
          export PATH=$(python3 -c 'import site; print(site.USER_BASE + "/bin")'):$PATH
          conan remote add conan-hep https://api.bintray.com/conan/expander/conan-hep --force
          conan install . --build=missing

      - name: Configure
        env:
          CXXCOMPILER: ${{ matrix.CXXCOMPILER }}
        run: |
          ./configure \
            --with-cxxflags="-std=c++14 -fPIC" \
            --with-cxx=$CXXCOMPILER \
            --with-optional-modules=test \
            --with-loop-libraries=collier,looptools \
            --with-install-dir=install \
            --disable-meta
          make showbuild

      - name: Make
        run: make -j2

      - name: Build compiled tests
        run: make -j2 alltest

      - name: Run compiled and shell script (Softsusy)
        # Makefile doesn't know about FLEXIBLESUSY_LOOP_LIBRARY flag so tests are not
        # re-run on FLEXIBLESUSY_LOOP_LIBRARY change. Every run must clean logs after itself.
        run: |
          FLEXIBLESUSY_LOOP_LIBRARY=0 make -j2 execute-compiled-tests execute-shell-tests
          make clean-test-log

      - name: Run compiled and shell script (Collier)
        run: |
          FLEXIBLESUSY_LOOP_LIBRARY=1 make -j2 execute-compiled-tests execute-shell-tests
          make clean-test-log

      - name: Run compiled and shell script (LoopTools)
        run: |
          FLEXIBLESUSY_LOOP_LIBRARY=2 make -j2 execute-compiled-tests execute-shell-tests
          make clean-test-log

      - name: Run compiled and shell script (fflite)
        run: |
          FLEXIBLESUSY_LOOP_LIBRARY=3 make -j2 execute-compiled-tests execute-shell-tests
          make clean-test-log

      - name: Install
        run: make install-src

  with-meta:

    # Pull requests don't share secrets with a fork so we run tests only on PRs
    # comming from the FlexibleSUSY/FlexibleSUSY repo.
    # For non PR triggers we check for the name of the repo so that if someone
    # forks FS github doesn't try to run tests on their code.
    if: (!github.event.pull_request && github.repository == 'FlexibleSUSY/FlexibleSUSY') || github.event.pull_request.head.repo.url == 'https://api.github.com/repos/FlexibleSUSY/FlexibleSUSY'

    runs-on: ubuntu-latest
    container:
      image: navir/opensuseleap-for-flexiblesusy:0.14.1

    strategy:
      fail-fast: false
      matrix:
        COMPILER: [intel]
        PART:     [2]

    env:
      FORMCALC_VERSION: '9.10'
      MODELS1: 'SM'
      MODELS2: 'CMSSM'

    steps:

      # action checks-out our repository directly under $GITHUB_WORKSPACE
      - name: Checkout
        uses: actions/checkout@v3

      - name: Activate Wolfram Engine
        env:
          MY_MATH_PASS:    ${{ secrets.MY_MATH_PASS }}
          MY_MAIL_ADDRESS: ${{ secrets.MY_MAIL_ADDRESS }}
        run: |
          wolframscript << EOF
          $MY_MAIL_ADDRESS
          $MY_MATH_PASS
          EOF
          printf "Checking if wolframscript command is workings... "; if [ $(wolframscript -code 1+2) -eq 3 ]; then echo OK; else echo fail && exit 1; fi
          printf "Checking if math command is workings... "; if [[ $(math -run "Print[7 673, $SystemID]; Exit[]" < /dev/null) =~ 4711([^$"\r\n"]*) ]]; then echo OK; else echo fail && exit 1; fi

      - name: Create models
        env:
          PART: ${{ matrix.PART }}
        run: |
          case "$PART" in
            "1") models=${MODELS1} ;;
            "2") models=${MODELS2} ;;
          esac
          for m in $models; do ./createmodel --name=$m; done

      - name: Set C++ environment
        env:
          COMPILER: ${{ matrix.COMPILER }}
        run: |
          # icpc doesn't support -Wpedantic
          case "$COMPILER" in
            "gcc")    echo "CXX=g++"     >> $GITHUB_ENV; echo "FC=gfortran" >> $GITHUB_ENV; echo "CXXFLAGS=-std=c++14 -O2 -fPIC -Wall -Wpedantic -pipe"           >> $GITHUB_ENV ;;
            "clang")  echo "CXX=clang++" >> $GITHUB_ENV; echo "FC=gfortran" >> $GITHUB_ENV; echo "CXXFLAGS=-std=c++14 -O2 -fPIC -Wall -Wpedantic -pipe"           >> $GITHUB_ENV ;;
            "intel")  echo "CXX=icpc"    >> $GITHUB_ENV; echo "FC=ifort"    >> $GITHUB_ENV; echo "CXXFLAGS=-std=c++14 -O0 -fPIC -fp-model precise -fp-model source -fp-model consistent -fimf-use-svml -no-fma -fimf-arch-consistency=true -qno-simd-honor-fp-model -mp1 -fimf-precision=high -fprotect-parens"    >> $GITHUB_ENV ;;
            *) exit 1 ;;
          esac

      - name: Configure
        env:
          COMPILER: ${{ matrix.COMPILER }}
          PART:        ${{ matrix.PART }}
        run: |
          case "$PART" in
            "1") models=${MODELS1} ;;
            "2") models=${MODELS2} ;;
          esac
          models=$(ruby -e "puts ARGV.join(',')" -- $models)
          [[ "$COMPILER" = "intel" ]] && source /opt/intel/oneapi/setvars.sh
          ./configure \
            --with-cxx=$CXX \
            --with-shared-lib-cmd="$CXX -std=c++14 -O0 -fp-model precise -fp-model source -fp-model consistent -fimf-use-svml -no-fma -fimf-arch-consistency=true  -qno-simd-honor-fp-model -mp1 -fimf-precision=high -fprotect-parens -shared -o" \
            --with-fc=$FC \
            --with-models=$models \
            --with-optional-modules=test \
            --enable-librarylink \
            --with-cxxflags="$CXXFLAGS"
          make showbuild

      - name: Make
        run: |
          [[ "$CXX" = "icpc" ]] && source /opt/intel/oneapi/setvars.sh
          make -j3

      - name: Build compiled tests
        run: |
          [[ "$CXX" = "icpc" ]] && source /opt/intel/oneapi/setvars.sh
          FLEXIBLESUSY_LOOP_LIBRARY=0 test/test_CMSSM_librarylink_slha.sh

      - name: (Optional) Save logs in case of an error
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: ${{matrix.CXXCOMPILER}}-${{matrix.PART}}_test-logs
          path: |
            test/test_CMSSM_librarylink_slha.out1.spc
            test/test_CMSSM_librarylink_slha.out2.spc
            test/test_CMSSM_librarylink_slha.in.m

